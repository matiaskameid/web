{% extends "base.html" %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'consignaciones_atico/css/styles.css' %}">
{% endblock %}

{% block title %}Consignaciones Atico{% endblock %}

{% block content %}
  <h2>Liquidaciones de Consignaciones</h2>

  {# Mensajes de alerta #}
  {% if messages %}
    <ul class="messages">
      {% for msg in messages %}
        <li class="{{ msg.tags }}">{{ msg }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {# ‚Äî S√≥lo mostrar fichero cuando ya haya editoriales (fase 2) ‚Äî #}
    {% if editorial_list and uploaded_file_name %}
      <p><strong>Archivo subido:</strong> {{ uploaded_file_name }}</p>
    {% endif %}

    {# ‚Äî FASE 1: Subida del Excel ‚Äî #}
    {% if not editorial_list %}
      {{ upload_form.as_p }}
      <button type="submit" name="upload">Procesar Archivo</button>

    {# ‚Äî FASE 2: Edici√≥n de contactos y generaci√≥n ‚Äî #}
    {% else %}
      <div id="contacts-section">
        {{ formset.management_form }}

        <h3>Completa los datos de contacto para cada editorial</h3>
        {% for form in formset %}
        <details class="editorial-panel">
          <summary>Datos para {{ form.initial.editorial }}</summary>
      
          {{ form.editorial }} {# HiddenInput #}
          <div class="contact-fields">
            <p>{{ form.PROVEEDOR.label_tag }} {{ form.PROVEEDOR }}</p>
            <p>{{ form.CONTACTO.label_tag }}  {{ form.CONTACTO }}</p>
            <p>{{ form.FONO_MAIL.label_tag }} {{ form.FONO_MAIL }}</p>
            <p>{{ form.DESCUENTO.label_tag }} {{ form.DESCUENTO }}</p>
            <p>{{ form.PAGO.label_tag }}      {{ form.PAGO }}</p>
            <p>{{ form.FECHA.label_tag }}     {{ form.FECHA }}</p>
          </div>
        </details>
      {% endfor %}

        <button type="submit" name="save_contacts">Guardar Contactos</button>
        <button type="submit" name="generate_liquidaciones">Generar Liquidaciones</button>
      </div>

      {% if generated_files %}
      <div class="feedback">
        <p class="success">‚úÖ Liquidaciones generadas para:</p>
        <ul>
          {% for name in generated_files %}
            <li>üìÑ {{ name }}</li>
          {% endfor %}
        </ul>
    
        <p>
          <a
            href="data:application/zip;base64,{{ zip_b64 }}"
            download="Liquidaciones.zip"
            class="btn-download"
          >
            üì¶ Descargar ZIP con todas las liquidaciones
          </a>
        </p>
    
        {% if no_data_editorials %}
          <p class="info">
            ‚ÑπÔ∏è No se generaron liquidaciones para:
          </p>
          <ul>
            {% for ed in no_data_editorials %}
              <li>{{ ed }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% endif %}

      {# Scroll suave a contacts-section #}
      <script>
        document
         .getElementById('contacts-section')
         .scrollIntoView({ behavior: 'smooth' });
      </script>
    {% endif %}
  </form>
{% endblock %}
